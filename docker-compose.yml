version: "3.9"

services:
  postgres:
    image: "${POSTGRES_IMAGE}"
    restart: unless-stopped
    environment:
      POSTGRES_DB: "${POSTGRES_DB}"
      POSTGRES_USER: "${POSTGRES_USER}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
    volumes:
      - ./data/postgres:/var/lib/postgresql/data:rw
    networks:
      - database

  zabbix-server:
    image: "${ZABBIX_SERVER_IMAGE}"
    restart: unless-stopped
    depends_on:
      - postgres
    ports:
      - "${ZABBIX_SERVER_PORT}:10051"
    environment:
      DB_SERVER_HOST: postgres
      DB_SERVER_PORT: "5432"
      POSTGRES_DB: "${POSTGRES_DB}"
      POSTGRES_USER: "${POSTGRES_USER}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
      # Keep simple for pilot; tweak if needed.
      ZBX_TIMEOUT: "30"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      # Optional persistence on host (uncomment and create dirs under ./data/zabbix):
      # - ./data/zabbix/export:/var/lib/zabbix/export:rw
      # - ./data/zabbix/modules:/var/lib/zabbix/modules:ro
      # - ./data/zabbix/alertscripts:/usr/lib/zabbix/alertscripts:ro
      # - ./data/zabbix/externalscripts:/usr/lib/zabbix/externalscripts:ro
    networks:
      - database
      - backend

  zabbix-web:
    image: "${ZABBIX_WEB_IMAGE}"
    restart: unless-stopped
    depends_on:
      - zabbix-server
    ports:
      - "${ZABBIX_WEB_HTTP_PORT}:8080"
      - "${ZABBIX_WEB_HTTPS_PORT}:8443"
    environment:
      DB_SERVER_HOST: postgres
      DB_SERVER_PORT: "5432"
      POSTGRES_DB: "${POSTGRES_DB}"
      POSTGRES_USER: "${POSTGRES_USER}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
      ZBX_SERVER_HOST: zabbix-server
      PHP_TZ: "${PHP_TZ}"
    volumes:
      - /etc/localtime:/etc/localtime:ro
    networks:
      - database
      - backend
      - frontend

  zabbix-proxy-sqlite3:
    image: "${ZABBIX_PROXY_SQLITE3_IMAGE}"
    restart: unless-stopped
    depends_on:
      - zabbix-server
    environment:
      # Tell the proxy how to reach the Zabbix server (inside Docker network)
      ZBX_SERVER_HOST: zabbix-server
      ZBX_SERVER_PORT: "10051"
      # How this proxy will appear in the Zabbix UI
      ZBX_HOSTNAME: "${ZABBIX_PROXY_HOSTNAME}"
      # Basic proxy behaviour â€“ defaults tuned for AV use, can be changed in .env
      ZBX_PROXYMODE: "${ZBX_PROXYMODE}"
      ZBX_PROXYBUFFERMODE: "${ZBX_PROXYBUFFERMODE}"
      ZBX_PROXYMEMORYBUFFERAGE: "${ZBX_PROXYMEMORYBUFFERAGE}"
      ZBX_PROXYMEMORYBUFFERSIZE: "${ZBX_PROXYMEMORYBUFFERSIZE}"
      ZBX_ENABLEREMOTECOMMANDS: "${ZBX_ENABLEREMOTECOMMANDS}"
    networks:
      - backend

networks:
  database:
    driver: bridge
  backend:
    driver: bridge
  frontend:
    driver: bridge
