version: "3.9"

# Profiles:
#   full  – postgres + zabbix-server + zabbix-web + zabbix-agent + zabbix-proxy
#   edge  – zabbix-agent + zabbix-proxy only (point at external Zabbix server via ZABBIX_SERVER_ADDRESS)
# Usage:
#   docker compose --profile full up -d   # everything
#   docker compose --profile edge up -d  # proxy & agent only

services:
  postgres:
    image: "${POSTGRES_IMAGE}"
    restart: unless-stopped
    profiles:
      - full
    environment:
      POSTGRES_DB: "${POSTGRES_DB}"
      POSTGRES_USER: "${POSTGRES_USER}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
    volumes:
      - ./data/postgres:/var/lib/postgresql/data:rw
    networks:
      - database

  zabbix-server:
    image: "${ZABBIX_SERVER_IMAGE}"
    restart: unless-stopped
    profiles:
      - full
    depends_on:
      - postgres
    ports:
      - "${ZABBIX_SERVER_PORT}:10051"
    environment:
      DB_SERVER_HOST: postgres
      DB_SERVER_PORT: "5432"
      POSTGRES_DB: "${POSTGRES_DB}"
      POSTGRES_USER: "${POSTGRES_USER}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
      # Keep simple for pilot; tweak if needed.
      ZBX_TIMEOUT: "30"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      # Optional persistence on host (uncomment and create dirs under ./data/zabbix):
      # - ./data/zabbix/export:/var/lib/zabbix/export:rw
      # - ./data/zabbix/modules:/var/lib/zabbix/modules:ro
      # - ./data/zabbix/alertscripts:/usr/lib/zabbix/alertscripts:ro
      # - ./data/zabbix/externalscripts:/usr/lib/zabbix/externalscripts:ro
    networks:
      - database
      - backend

  zabbix-web:
    image: "${ZABBIX_WEB_IMAGE}"
    restart: unless-stopped
    profiles:
      - full
    depends_on:
      - zabbix-server
    ports:
      - "${ZABBIX_WEB_HTTP_PORT}:8080"
      - "${ZABBIX_WEB_HTTPS_PORT}:8443"
    environment:
      DB_SERVER_HOST: postgres
      DB_SERVER_PORT: "5432"
      POSTGRES_DB: "${POSTGRES_DB}"
      POSTGRES_USER: "${POSTGRES_USER}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
      ZBX_SERVER_HOST: zabbix-server
      PHP_TZ: "${PHP_TZ}"
    volumes:
      - /etc/localtime:/etc/localtime:ro
    networks:
      - database
      - backend
      - frontend

  zabbix-proxy:
    image: "${ZABBIX_PROXY_IMAGE}"
    restart: unless-stopped
    profiles:
      - full
      - edge
    environment:
      # Full stack: ZABBIX_SERVER_ADDRESS unset → zabbix-server. Edge: set to central server hostname/IP
      ZBX_SERVER_HOST: "${ZABBIX_SERVER_ADDRESS:-zabbix-server}"
      ZBX_SERVER_PORT: "${ZABBIX_SERVER_PORT:-10051}"
      # How this proxy will appear in the Zabbix UI
      ZBX_HOSTNAME: "${ZABBIX_PROXY_HOSTNAME}"
      # Basic proxy behaviour – defaults tuned for AV use, can be changed in .env
      ZBX_PROXYMODE: "${ZBX_PROXYMODE}"
      ZBX_PROXYBUFFERMODE: "${ZBX_PROXYBUFFERMODE}"
      ZBX_PROXYMEMORYBUFFERAGE: "${ZBX_PROXYMEMORYBUFFERAGE}"
      ZBX_PROXYMEMORYBUFFERSIZE: "${ZBX_PROXYMEMORYBUFFERSIZE}"
      ZBX_ENABLEREMOTECOMMANDS: "${ZBX_ENABLEREMOTECOMMANDS}"
    networks:
      - backend

  # Full stack: monitors this host. Edge: reports to central server (ZABBIX_SERVER_ADDRESS)
  zabbix-agent:
    image: "${ZABBIX_AGENT_IMAGE}"
    restart: unless-stopped
    profiles:
      - full
      - edge
    init: true
    privileged: true
    pid: "host"
    ports:
      - "${ZABBIX_AGENT_PORT}:10050"
    environment:
      ZBX_SERVER_HOST: "${ZABBIX_SERVER_ADDRESS:-zabbix-server}"
      ZBX_SERVER_PORT: "${ZABBIX_SERVER_PORT:-10051}"
      # Host name as it will appear in Zabbix UI (create a host with this name and link the agent)
      ZBX_HOSTNAME: "${ZABBIX_AGENT_HOSTNAME}"
    volumes:
      - /etc/localtime:/etc/localtime:ro
    networks:
      - backend

networks:
  database:
    driver: bridge
  backend:
    driver: bridge
  frontend:
    driver: bridge
